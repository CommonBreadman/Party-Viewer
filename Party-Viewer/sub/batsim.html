<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battle Simulator</title>
    <link rel="stylesheet" href="../style/master.css">
    <link rel="stylesheet" href="../style/batsim.css">
</head>
<body>
    <h1>Battle Simulator</h1>
    <form id="battleForm">
        <!--commander1 = Commander("General A", strength=80, intelligence=0, agility=75, stamina=85, leadership=90, experience=60, skill=80, traits=["Panzer Leader", "People's Army"])
commander2 = Commander("General B", strength=75, intelligence=85, agility=100, stamina=80, leadership=75, experience=70, skill=85, traits=["Combined Arms Expert", "Strategist"])-->

        <h2>Commander1</h2>
        <label>Name: <input type="text" name="commander1_name" required></label><br>
        <label>Strength: <input type="number" name="commander1_strength" required></label><br>
        <label>Intelligence: <input type="number" name="commander1_intelligence" required></label><br>
        <label>Agility: <input type="number" name="commander1_agility" required></label><br>
        <label>Stamina: <input type="number" name="commander1_stamina" required></label><br>
        <label>Leadership: <input type="number" name="commander1_leadership" required></label><br>
        <label>Experience: <input type="number" name="commander1_experience" required></label><br>
        <label>Skill: <input type="number" name="commander1_skill" required></label><br>
        <label>Traits: <input type="text" name="commander1_traits" required></label><br>

        <h2>Commander2</h2>
        <label>Name: <input type="text" name="commander2_name" required></label><br>
        <label>Strength: <input type="number" name="commander2_strength" required></label><br>
        <label>Intelligence: <input type="number" name="commander2_intelligence" required></label><br>
        <label>Agility: <input type="number" name="commander2_agility" required></label><br>    
        <label>Stamina: <input type="number" name="commander2_stamina" required></label><br>
        <label>Leadership: <input type="number" name="commander2_leadership" required></label><br>
        <label>Experience: <input type="number" name="commander2_experience" required></label><br>
        <label>Skill: <input type="number" name="commander2_skill" required></label><br>
        <label>Traits: <input type="text" name="commander2_traits" required></label><br>
        <!--division1 = Division("1st Division", attack=80, defense=75, morale=80, size=900, fatigue=1, troop_count=10000, equipment=equipment1, organization=80, skill=9, strategy="Banzai Charge")-->

        <h2>Division1</h2>
        <label>Name: <input type="text" name="division1_name" required></label><br>
        <label>Attack: <input type="number" name="division1_attack" required></label><br>
        <label>Defense: <input type="number" name="division1_defense" required></label><br>
        <label>Morale: <input type="number" name="division1_morale" required></label><br>
        <label>Size: <input type="number" name="division1_size" required></label><br>
        <label>Fatigue: <input type="number" name="division1_fatigue" required></label><br>
        <label>Troop Count: <input type="number" name="division1_troop_count" required></label><br>
        <label>Equipment: <input type="text" name="division1_equipment" required></label><br>
        <label>Organization: <input type="number" name="division1_organization" required></label><br>
        <label>Skill: <input type="number" name="division1_skill" required></label><br>
        <label>Strategy: <input type="text" name="division1_strategy" required></label><br>

        <h2>Division2</h2>
        <label>Name: <input type="text" name="division2_name" required></label><br>
        <label>Attack: <input type="number" name="division2_attack" required></label><br>
        <label>Defense: <input type="number" name="division2_defense" required></label><br>
        <label>Morale: <input type="number" name="division2_morale" required></label><br>
        <label>Size: <input type="number" name="division2_size" required></label><br>
        <label>Fatigue: <input type="number" name="division2_fatigue" required></label><br>
        <label>Troop Count: <input type="number" name="division2_troop_count" required></label><br>
        <label>Equipment: <input type="text" name="division2_equipment" required></label><br>
        <label>Organization: <input type="number" name="division2_organization" required></label><br>
        <label>Skill: <input type="number" name="division2_skill" required></label><br>
        <label>Strategy: <input type="text" name="division2_strategy" required></label><br>

        <h2>Equipment1</h2><!--equipment1 = Equipment(artillery=50, tanks=30, apcs=20, anti_air=10, anti_tank=15, air_superiority=25, planes=20, base_equipment=100)-->
        <label>Artillery: <input type="number" name="equipment1_artillery" required></label><br>
        <label>Tanks: <input type="number" name="equipment1_tanks" required></label><br>
        <label>APCs: <input type="number" name="equipment1_apcs" required></label><br>
        <label>Anti-Air: <input type="number" name="equipment1_anti_air" required></label><br>
        <label>Anti-Tank: <input type="number" name="equipment1_anti_tank" required></label><br>
        <label>Air Superiority: <input type="number" name="equipment1_air_superiority" required></label><br>
        <label>Planes: <input type="number" name="equipment1_planes" required></label><br>
        <label>Base Equipment: <input type="number" name="equipment1_base_equipment" required></label><br>

        <h2>Equipment2</h2><!--equipment2 = Equipment(artillery=40, tanks=25, apcs=15, anti_air=12, anti_tank=18, air_superiority=20, planes=15, base_equipment=90)-->
        <label>Artillery: <input type="number" name="equipment2_artillery" required></label><br>
        <label>Tanks: <input type="number" name="equipment2_tanks" required></label><br>
        <label>APCs: <input type="number" name="equipment2_apcs" required></label><br>
        <label>Anti-Air: <input type="number" name="equipment2_anti_air" required></label><br>
        <label>Anti-Tank: <input type="number" name="equipment2_anti_tank" required></label><br>
        <label>Air Superiority: <input type="number" name="equipment2_air_superiority" required></label><br>
        <label>Planes: <input type="number" name="equipment2_planes" required></label><br>
        <label>Base Equipment: <input type="number" name="equipment2_base_equipment" required></label><br>

        <!--airforce1 = AirForce(aircraft_quality=80, aircraft_quantity=50, pilot_skill=75, logistics=70, radar_coverage=60, anti_air_support=40)-->
        <h2>Airforce1</h2>
        <label>Aircraft Quality: <input type="number" name="airforce1_aircraft_quality" required></label><br>
        <label>Aircraft Quantity: <input type="number" name="airforce1_aircraft_quantity" required></label><br>
        <label>Pilot Skill: <input type="number" name="airforce1_pilot_skill" required></label><br>
        <label>Logistics: <input type="number" name="airforce1_logistics" required></label><br>
        <label>Radar Coverage: <input type="number" name="airforce1_radar_coverage" required></label><br>
        <label>Anti-Air Support: <input type="number" name="airforce1_anti_air_support" required></label><br>        
        <button type="submit">Resolve Battle</button>
    </form>

    <div class="result" id="result"></div>

    <script>
class Commander {
    constructor(name, strength, intelligence, agility, stamina, leadership, experience, skill, traits = []) {
        this.name = name;
        this.strength = strength;
        this.intelligence = intelligence;
        this.agility = agility;
        this.stamina = stamina;
        this.leadership = leadership;
        this.experience = experience;
        this.skill = skill;
        this.traits = traits;
    }
}

class Division {
    constructor(name, attack, defense, morale, size, fatigue, troopCount, equipment, organization, skill, strategy, traits = []) {
        this.name = name;
        this.attack = attack;
        this.defense = defense;
        this.morale = morale;
        this.organization = organization;
        this.size = size;
        this.fatigue = fatigue;
        this.troopCount = troopCount;
        this.equipment = equipment;
        this.strategy = strategy;
        this.skill = skill;
        this.traits = traits;
    }
}

class Equipment {
    constructor(artillery, tanks, apcs, antiAir, antiTank, airSuperiority, planes, baseEquipment) {
        this.artillery = artillery;
        this.tanks = tanks;
        this.apcs = apcs;
        this.antiAir = antiAir;
        this.antiTank = antiTank;
        this.airSuperiority = airSuperiority;
        this.planes = planes;
        this.baseEquipment = baseEquipment;
    }
}

class AirForce {
    constructor(aircraftQuality, aircraftQuantity, pilotSkill, logistics, radarCoverage, antiAirSupport) {
        this.aircraftQuality = aircraftQuality;
        this.aircraftQuantity = aircraftQuantity;
        this.pilotSkill = pilotSkill;
        this.logistics = logistics;
        this.radarCoverage = radarCoverage;
        this.antiAirSupport = antiAirSupport;
    }
}

class Strategy {
    constructor(name, attackModifier = 0, defenseModifier = 0, counteredBy = []) {
        this.name = name;
        this.attackModifier = attackModifier;
        this.defenseModifier = defenseModifier;
        this.counteredBy = counteredBy;
    }
}

const strategies = {
    "Counter-Attack": {
        attackModifier: 0.05,
        defenseModifier: 0,
        conditions: [division => division.skill > 0]
    },
    "Assault": {
        attackModifier: 0.25,
        defenseModifier: 0,
        conditions: [
            commander => commander.traits.includes("Aggressive Assaulter"),
            division => division.terrain === "city"
        ]
    },
    "Blitz": {
        attackModifier: 0.1,
        defenseModifier: 0.1,
        conditions: [division => division.terrain === "hills"]
    },
    "Banzai Charge": {
        attackModifier: 0.1,
        defenseModifier: 0.1,
        conditions: [division => division.terrain === "urban"]
    }
};

const traits = {
    "Aggressive Assaulter": {
        description: "Increases attack power in urban terrain.",
        attackBonus: 0.4,
        defenseBonus: 0
    },
    "Panzer Leader": {
        description: "Enhances effectiveness of armored divisions.",
        attackBonus: 0.25,
        defenseBonus: 0
    },
    "People's Army": {
        description: "Increases attack power in urban terrain.",
        attackBonus: 0.4,
        defenseBonus: 0
    }
};

function calculateEffectiveness(division) {
    let attack = division.attack;
    let defense = division.defense;

    division.traits.forEach(trait => {
        if (traits[trait]) {
            attack += attack * traits[trait].attackBonus;
            defense += defense * traits[trait].defenseBonus;
        }
    });

    return { attack, defense };
}

function calculateCommanderEffectiveness(commander) {
    return (
        0.4 * commander.strength +
        0.2 * commander.intelligence +
        0.15 * commander.agility +
        0.1 * commander.stamina +
        0.1 * commander.leadership +
        0.05 * commander.experience
    );
}

function calculateDivisionCombatPower(division) {
    let combatPower = (division.attack * 0.5 + division.defense * 0.3 + division.morale * 0.2) * (division.size / 100);
    combatPower *= division.fatigue;
    combatPower *= (division.troopCount / 1000);

    const equipmentPower = (
        division.equipment.artillery * 1.2 +
        division.equipment.tanks * 1.5 +
        division.equipment.apcs * 1.1 +
        division.equipment.antiAir * 0.8 +
        division.equipment.antiTank * 1.3 +
        division.equipment.airSuperiority * 1.4 +
        division.equipment.planes * 2.0 +
        division.equipment.baseEquipment * 0.5
    );

    combatPower += equipmentPower;
    return combatPower;
}

function calculateAirSuperiority(airforce) {
    const weights = {
        aircraftQuality: 0.3,
        aircraftQuantity: 0.25,
        pilotSkill: 0.2,
        logistics: 0.1,
        radarCoverage: 0.1,
        antiAirSupport: 0.05
    };
    const quantityScore = Math.min(airforce.aircraftQuantity / 100, 1);

    return (
        weights.aircraftQuality * airforce.aircraftQuality +
        weights.aircraftQuantity * quantityScore +
        weights.pilotSkill * airforce.pilotSkill +
        weights.logistics * airforce.logistics +
        weights.radarCoverage * airforce.radarCoverage +
        weights.antiAirSupport * airforce.antiAirSupport
    );
}

function luckFactor() {
    const luck = Math.random() * 0.6 + 0.7;
    if (Math.random() < 0.01) {
        return Math.random() * 0.5 + 1.5;
    } else if (Math.random() < 0.01) {
        return Math.random() * 0.3 + 0.2;
    }
    return luck;
}

function calculateCriticalHit(commander, division) {
    const critChance = (commander.agility * 0.05) + (division.morale * 0.02);
    return Math.random() * 100 < critChance ? 1.25 : 1.0;
}

function calculateTerrainModifier(terrainType) {
    const terrainModifiers = {
        flat: 1.0,
        hills: 1.1,
        forest: 1.05,
        city: 1.2,
        river: 1.15,
        mountains: 2.0
    };
    return terrainModifiers[terrainType] || 1.0;
}

function gainExperience(commander, won, challengeFactor) {
    if (won) {
        commander.experience += Math.random() * 2 + 1 * challengeFactor;
    } else {
        commander.experience += Math.random() * 3 + 3 * challengeFactor;
    }
}

function calculateBattleScore(commander1, division1, commander2, division2, airforce1, airforce2, terrain = "hills") {
    /** 
     * Calculate the battle score between two commanders and their divisions.
     * @param {Object} commander1 - The first commander's attributes.
     * @param {Object} division1 - The first division's attributes.
     * @param {Object} commander2 - The second commander's attributes.
     * @param {Object} division2 - The second division's attributes.
     * @param {Object} airforce1 - The air support for the first side.
     * @param {Object} airforce2 - The air support for the second side.
     * @param {string} terrain - The type of terrain for the battle (default "hills").
     * @returns {Object} - An object containing battle results, scores, losses, and victory types.
     */

    // Input validation
    if (typeof division1.troopCount !== 'number' || division1.troopCount <= 0) {
        throw new Error("Division 1 must have a valid troop count.");
    }
    if (typeof division2.troopCount !== 'number' || division2.troopCount <= 0) {
        throw new Error("Division 2 must have a valid troop count.");
    }

    const battleDuration = estimateBattleDuration(division1, division2);
    
    const effectiveness1 = calculateCommanderEffectiveness(commander1);
    const effectiveness2 = calculateCommanderEffectiveness(commander2);

    const entrenchmentBonus1 = calculateEntrenchmentBonus(battleDuration);
    const entrenchmentBonus2 = calculateEntrenchmentBonus(battleDuration);

    const strategy1 = strategies[division1.strategy] || {};
    const strategy2 = strategies[division2.strategy] || {};

    let power1 = calculateDivisionCombatPower(division1) * entrenchmentBonus1;
    let power2 = calculateDivisionCombatPower(division2) * entrenchmentBonus2;

    // Apply strategy modifiers if conditions are met
    if (strategy1.conditions && strategy1.conditions.every(condition => condition(division1))) {
        power1 *= (1 + strategy1.attackModifier);
        power1 *= (1 + strategy1.defenseModifier);
    }

    if (strategy2.conditions && strategy2.conditions.every(condition => condition(division2))) {
        power2 *= (1 + strategy2.attackModifier);
        power2 *= (1 + strategy2.defenseModifier);
    }

    power1 *= luckFactor();
    power2 *= luckFactor();

    const critHit1 = calculateCriticalHit(commander1, division1);
    const critHit2 = calculateCriticalHit(commander2, division2);
    power1 *= critHit1;
    power2 *= critHit2;

    const terrainModifier = calculateTerrainModifier(terrain);
    power1 *= terrainModifier;
    power2 *= terrainModifier;

    let totalScore1 = effectiveness1 + power1;
    let totalScore2 = effectiveness2 + power2;

    const airSuperiority1 = calculateAirSuperiority(airforce1);
    const airSuperiority2 = calculateAirSuperiority(airforce2);

    totalScore1 += airSuperiority1 * 1.5;
    totalScore2 += airSuperiority2 * 1.5;

    const troopLosses1 = calculateTroopLosses(division1, division2, totalScore1, totalScore2);
    const troopLosses2 = calculateTroopLosses(division2, division1, totalScore2, totalScore1);

    const equipLosses1 = calculateEquipmentLosses(division1, division2, totalScore1, totalScore2, airforce1);
    const equipLosses2 = calculateEquipmentLosses(division2, division1, totalScore2, totalScore1, airforce2);

    let victoryType1 = determineVictoryType(troopLosses2, division2.troopCount);
    let victoryType2 = determineVictoryType(troopLosses1, division1.troopCount);

    // Determine the victory types based on the results
    if (victoryType1 === "Total Victory") {
        victoryType2 = "Total Defeat";
    } else if (victoryType2 === "Total Victory") {
        victoryType1 = "Total Defeat";
    }

    if (victoryType1 === "Victory" && victoryType2 === "Victory") {
        if (totalScore1 > totalScore2) {
            victoryType2 = "Defeat";
        } else {
            victoryType1 = "Defeat";
        }
    }

    if (victoryType1 === "Minor Victory" && victoryType2 === "Minor Victory") {
        if (totalScore1 > totalScore2) {
            victoryType2 = "Minor Defeat";
        } else {
            victoryType1 = "Minor Defeat";
        }
    }

    if (battleDuration >= 327 && !(victoryType1 === "Total Victory" || victoryType2 === "Total Victory")) {
        return {
            commander1Score: totalScore1,
            commander2Score: totalScore2,
            troopLosses1: troopLosses1,
            troopLosses2: troopLosses2,
            equipmentLosses1: equipLosses1,
            equipmentLosses2: equipLosses2,
            victoryType1: "Draw",
            victoryType2: "Draw",
            estimatedDuration: battleDuration
        };
    }

    return {
        commander1Score: totalScore1,
        commander2Score: totalScore2,
        troopLosses1: troopLosses1,
        troopLosses2: troopLosses2,
        equipmentLosses1: equipLosses1,
        equipmentLosses2: equipLosses2,
        victoryType1: victoryType1,
        victoryType2: victoryType2,
        estimatedDuration: battleDuration
    };
}
document.getElementById('battleForm').addEventListener('submit', function(event) {
    event.preventDefault();

    const formData = new FormData(event.target);

    const commander1 = new Commander(
        formData.get('commander1_name'),
        parseInt(formData.get('commander1_strength')),
        parseInt(formData.get('commander1_intelligence')),
        parseInt(formData.get('commander1_agility')),
        parseInt(formData.get('commander1_stamina')),
        parseInt(formData.get('commander1_leadership')),
        parseInt(formData.get('commander1_experience')),
        parseInt(formData.get('commander1_skill')),
        formData.get('commander1_traits').split(',')
    );

    const commander2 = new Commander(
        formData.get('commander2_name'),
        parseInt(formData.get('commander2_strength')),
        parseInt(formData.get('commander2_intelligence')),
        parseInt(formData.get('commander2_agility')),
        parseInt(formData.get('commander2_stamina')),
        parseInt(formData.get('commander2_leadership')),
        parseInt(formData.get('commander2_experience')),
        parseInt(formData.get('commander2_skill')),
        formData.get('commander2_traits').split(',')
    );

    const equipment1 = new Equipment(
        parseInt(formData.get('equipment1_artillery')),
        parseInt(formData.get('equipment1_tanks')),
        parseInt(formData.get('equipment1_apcs')),
        parseInt(formData.get('equipment1_anti_air')),
        parseInt(formData.get('equipment1_anti_tank')),
        parseInt(formData.get('equipment1_air_superiority')),
        parseInt(formData.get('equipment1_planes')),
        parseInt(formData.get('equipment1_base_equipment'))
    );

    const division1 = new Division(
        formData.get('division1_name'),
        parseInt(formData.get('division1_attack')),
        parseInt(formData.get('division1_defense')),
        parseInt(formData.get('division1_morale')),
        parseInt(formData.get('division1_size')),
        parseFloat(formData.get('division1_fatigue')),
        parseInt(formData.get('division1_troop_count')),
        equipment1,
        parseInt(formData.get('division1_organization')),
        parseInt(formData.get('division1_skill')),
        formData.get('division1_strategy')
    );

    const equipment2 = new Equipment(
        parseInt(formData.get('equipment2_artillery')),
        parseInt(formData.get('equipment2_tanks')),
        parseInt(formData.get('equipment2_apcs')),
        parseInt(formData.get('equipment2_anti_air')),
        parseInt(formData.get('equipment2_anti_tank')),
        parseInt(formData.get('equipment2_air_superiority')),
        parseInt(formData.get('equipment2_planes')),
        parseInt(formData.get('equipment2_base_equipment'))
    );

    const division2 = new Division(
        formData.get('division2_name'),
        parseInt(formData.get('division2_attack')),
        parseInt(formData.get('division2_defense')),
        parseInt(formData.get('division2_morale')),
        parseInt(formData.get('division2_size')),
        parseFloat(formData.get('division2_fatigue')),
        parseInt(formData.get('division2_troop_count')),
        equipment2,
        parseInt(formData.get('division2_organization')),
        parseInt(formData.get('division2_skill')),
        formData.get('division2_strategy')
    );

    const airforce1 = new AirForce(
        parseInt(formData.get('airforce1_aircraft_quality')),
        parseInt(formData.get('airforce1_aircraft_quantity')),
        parseInt(formData.get('airforce1_pilot_skill')),
        parseInt(formData.get('airforce1_logistics')),
        parseInt(formData.get('airforce1_radar_coverage')),
        parseInt(formData.get('airforce1_anti_air_support'))
    );

    const airforce2 = new AirForce(
        parseInt(formData.get('airforce2_aircraft_quality')),
        parseInt(formData.get('airforce2_aircraft_quantity')),
        parseInt(formData.get('airforce2_pilot_skill')),
        parseInt(formData.get('airforce2_logistics')),
        parseInt(formData.get('airforce2_radar_coverage')),
        parseInt(formData.get('airforce2_anti_air_support'))
    );

    const results = calculateBattleScore(commander1, division1, commander2, division2, airforce1, airforce2, "hills");
    console.log(results);
    // Change here from calculate_battle_score to calculateBattleScore

});






    </script>
</body>
</html>
